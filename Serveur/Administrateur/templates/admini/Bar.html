{% extends 'admini/base.html' %}
{% load static %}
{% load i18n %}
{% block content %}
<link rel="stylesheet" href="{% static 'adm/css/menu_graphe.css' %}">
<link rel="stylesheet" href="{% static 'adm/css/tous_graphe.css' %}">
<div id="container">
    <div class="d-flex justify-content-between align-items-center">
        <h5 class="text-center alert text-bg-warning mb-xxl-5" style="width: 80%; margin-left: 50px;">{% trans 'Affichage des données actuelles' %}: {{esp.lieu}}</h5>
        
        <ul class="menu text-center alert text-bg-warning mb-xxl-5">
            <li class="dropdown">
                <a href="#"> {% trans 'Autre options' %} <i class="fas fa-caret-down"></i></a>
                <ul class="dropdown-menu">
                    <li><a href="{% url 'courbe_admin' esp_id=esp_id %}">{% trans 'Graphique courbe' %}</a></li>
                    <li><a href="{% url 'bar_admin' esp_id=esp_id %}">{% trans 'Graphique bar' %}</a></li>
                    <li><a href="{% url 'jauge_admin' esp_id=esp_id %}">{% trans 'Graphique jauge' %}</a></li>
                    <li><a href="{% url 'histo_esp' esp_id=esp_id %}">{% trans 'Historique' %}</a></li>
                </ul>
            </li>
        </ul>
    </div>

    <div class="charts-container">
        <div class="charts-row">
            <div class="chart-wrapper">
                <p style="text-align: center;"><strong>{% trans 'Feux :' %} <span id="feux">--</span></strong></p>
                <div id="feuxChart" class="chart" style="width: 700px; height: 400px;"></div>
            </div>
            <div class="chart-wrapper">
                <p style="text-align: center;"><strong>{% trans 'CO2 :' %} <span id="gaz">--</span></strong></p>
                <div id="gazChart" class="chart" style="width: 700px; height: 400px; margin: 0;"></div>
            </div>
            
        </div>
        
        <div class="charts-row">
            <div class="chart-wrapper">
                <p style="text-align: center;"><strong>{% trans 'Température' %} : <span id="temperature">--</span></strong></p>
                <div id="temperatureChart" class="chart" style="width: 700px; height: 400px;"></div>
            </div>
            <div class="chart-wrapper">
                <p style="text-align: center;"><strong>{% trans 'Humidité' %} : <span id="humidity">--</span></strong></p>
                <div id="humidityChart" class="chart" style="width: 700px; height: 400px;"></div>
            </div>
        </div>
    </div>
    <a href="{% url 'add_dht_data' %}">Ajouter des données DHT</a>
</div>
<div id="Stemp" 
data-min="{{ seuils.tempMin }}" 
data-max="{{ seuils.tempMax }}">
</div>
<div id="Shum" 
data-min="{{ seuils.humMin }}" 
data-max="{{ seuils.humMax }}">
<div id="Sgaz" 
data-min="{{ seuils.gazMin }}" 
data-max="{{ seuils.gazMax }}">
</div>
<script>
    $(document).ready(function() {
        var temperatureChart = echarts.init(document.getElementById('temperatureChart'));
        var humidityChart = echarts.init(document.getElementById('humidityChart'));
        var gazChart = echarts.init(document.getElementById('gazChart'));
        var feuxChart = echarts.init(document.getElementById('feuxChart'));

        var temperatureData = { labels: [], values: [] };
        var humidityData = { labels: [], values: [] };
        var gazData = { labels: [], values: [] };
      // Récupérer les valeurs des seuils depuis les attributs data-* de l'élément
      var tempMin = parseFloat(document.getElementById('Stemp').dataset.min);
        var tempMax = parseFloat(document.getElementById('Stemp').dataset.max);
        var humMin = parseFloat(document.getElementById('Shum').dataset.min);
        var humMax = parseFloat(document.getElementById('Shum').dataset.max);
        var gazMin = parseFloat(document.getElementById('Sgaz').dataset.min);
        var gazMax = parseFloat(document.getElementById('Sgaz').dataset.max);

        function getTemperatureColor(value) {
            if (value < tempMin) return 'blue';
            else if (value >= tempMin && value <= tempMax) return 'green';
            else return 'red';
        }

        function getHumidityColor(value) {
            if (value < humMin) return 'blue';
            else if (value >= humMin && value <= humMax) return 'green';
            else return 'red';
        }

        function getGazColor(value) {
            if (value < gazMin) return 'blue';
            else if (value >= gazMin && value <= gazMax) return 'green';
            else return 'red';
        }
        function determineFeuxColor(feuxState) {
        if (feuxState == 'Oui'){
            return 'red';
        } 
        else {
            return 'green';
        }
    }

        function createStackedBarOption(name, data, colorFunc) {
            return {
                xAxis: {
                    type: 'category',
                    boundaryGap: true,
                    data: data.labels,
                    axisLabel: { color: '#000', fontSize: 14, fontWeight: 'bold' },
                    axisLine: { lineStyle: { color: '#333', width: 2 } },
                    axisTick: { show: true, lineStyle: { color: '#333', width: 1 } },
                    splitLine: { show: true, lineStyle: { color: '#ddd', width: 1 } }
                },
                yAxis: {
                    type: 'value',
                    axisLabel: { color: '#000', fontSize: 14, fontWeight: 'bold' },
                    axisLine: { lineStyle: { color: '#333', width: 2 } },
                    axisTick: { show: true, lineStyle: { color: '#333', width: 1 } },
                    splitLine: { show: true, lineStyle: { color: '#ddd', width: 1 } }
                },
                series: [
                    {
                        name: name,
                        type: 'bar',
                        data: data.values.map(value => ({
                            value: value,
                            itemStyle: { color: colorFunc(value) }
                        })),
                        emphasis: {
                            itemStyle: {
                                borderColor: 'rgba(0, 0, 0, 0.7)'
                            }
                        }
                    }
                ]
            };
        }
        function createPieOption(title, data, feuxState) {
    return {
        title: {
            text: title,
            subtext: 'Statistiques des feux',
            left: 'center'
        },
        tooltip: {
            trigger: 'item'
        },
        series: [{
            type: 'pie',
            radius: '50%',
            data: data,
            itemStyle: {
                color: function(params) {
                    // Utilisez la fonction determineFeuxColor pour définir la couleur en fonction de l'état des feux
                    return determineFeuxColor(feuxState);
                }
            },
            emphasis: {
                itemStyle: {
                    shadowBlur: 10,
                    shadowOffsetX: 0,
                    shadowColor: 'rgba(0, 0, 0, 0.5)'
                }
            },
            animationType: 'scale',
            animationEasing: 'elasticOut',
            animationDuration: 10000,
            animationDelay: function (idx) {
                return Math.random() * 1000;
            }
        }]
    };
}


        function fetchData() {
            $.ajax({
                url: "{% url 'get_data' esp_id=esp_id %}",
                method: 'GET',
                success: function(data) {
                    var now = new Date();
                    var time = now.getHours() + ":" + now.getMinutes() + ":" + now.getSeconds();
                    
                    temperatureData.labels.push(time);
                    temperatureData.values.push(data.temperature);

                    humidityData.labels.push(time);
                    humidityData.values.push(data.humidity);

                    gazData.labels.push(time);
                    gazData.values.push(data.gaz);

                    if (temperatureData.labels.length > 10) {
                        temperatureData.labels.shift();
                        temperatureData.values.shift();
                        humidityData.labels.shift();
                        humidityData.values.shift();
                        gazData.labels.shift();
                        gazData.values.shift();
                    }
      // Définir les données des feux
      var feuxData = [
                     { name: 'État normal', value: data.feux === 'Oui' ? 0 : 1 }, 
                     { name: 'État d\'alerte', value: data.feux === 'Oui' ? 1 : 0 }
                 ];
                    // Mettre à jour les graphiques avec les couleurs dynamiques
                    temperatureChart.setOption(createStackedBarOption('Température', temperatureData, getTemperatureColor));
                    humidityChart.setOption(createStackedBarOption('Humidité', humidityData, getHumidityColor));
                    gazChart.setOption(createStackedBarOption('Gaz', gazData, getGazColor));
                    feuxChart.setOption(createPieOption(' {% trans "Etat des feux" %}', feuxData, data.feux));
         
                 
                    $('#temperature').text(data.temperature + '°C');
                    $('#humidity').text(data.humidity + '%');
                    $('#gaz').text(data.gaz + 'PPM');
                    $('#feux').text(data.feux).css('color', determineFeuxColor(data.feux));
                },
                error: function() {
                    console.log('Erreur lors de la récupération des données');
                }
            });
        }

        fetchData();
        setInterval(fetchData, 2000);
    });
 
</script>

{% endblock content %}
