{% extends 'admini/base.html' %}
{% load static %}
{% block content %}
<link rel="stylesheet" href="{% static 'adm/css/menu_graphe.css' %}">
<link rel="stylesheet" href="{% static 'adm/css/tous_graphe.css' %}">
<div id="container">
    <div class="d-flex justify-content-between align-items-center">
        <h5 class="text-center alert text-bg-warning mb-xxl-5" style="width: 80%; margin-left: 50px;">Affichage des données actuelles: {{esp.lieu}}</h5>
        
        <ul class="menu text-center alert text-bg-warning mb-xxl-5">
            <li class="dropdown">
                <a href="#">Type de graphique <i class="fas fa-caret-down"></i></a>
                <ul class="dropdown-menu">
                    <li><a href="{% url 'courbe_admin' esp_id=esp_id %}">Graphique courbe</a></li>
                    <li><a href="{% url 'bar_admin' esp_id=esp_id %}">Graphique bar</a></li>
                    <li><a href="{% url 'jauge_admin' esp_id=esp_id %}">Graphique jauge</a></li>
                    <li><a href="{% url 'histo_esp' esp_id=esp_id %}">Historique</a></li>
                </ul>
            </li>
        </ul>
    </div>

    <div class="charts-container">
        <div class="charts-row">
            <div class="chart-wrapper">
                <p style="text-align: center;"><strong>Température : <span id="temperature">--</span></strong></p>
                <div id="temperatureChart" class="chart" style="width: 700px; height: 400px;"></div>
            </div>
            <div class="chart-wrapper">
                <p style="text-align: center;"><strong>Humidité : <span id="humidity">--</span></strong></p>
                <div id="humidityChart" class="chart" style="width: 700px; height: 400px;"></div>
            </div>
        </div>

        <div class="chart-wrapper">
            <div class="chart-gaz">
                <p style="text-align: center;"><strong>Gaz : <span id="gaz">--</span></strong></p>
                <div id="gazChart" class="chart" style="width: 700px; height: 400px; margin: 0;"></div>
            </div>
        </div>
    </div>

    <a href="{% url 'add_dht_data' %}">Ajouter des données DHT</a>
</div>

<script>
    $(document).ready(function() {
        var temperatureChart = echarts.init(document.getElementById('temperatureChart'));
        var humidityChart = echarts.init(document.getElementById('humidityChart'));
        var gazChart = echarts.init(document.getElementById('gazChart'));

        var temperatureData = { labels: [], values: [] };
        var humidityData = { labels: [], values: [] };
        var gazData = { labels: [], values: [] };

        function getTemperatureColor(value) {
            if (value < 20) return 'blue';
            else if (value >= 20 && value <= 25) return 'green';
            else return 'red';
        }

        function getHumidityColor(value) {
            if (value < 40) return 'blue';
            else if (value >= 40 && value <= 60) return 'green';
            else return 'red';
        }

        function getGazColor(value) {
            return value < 1000 ? 'green' : 'red';
        }

        function createStackedBarOption(name, data, colorFunc) {
            return {
                xAxis: {
                    type: 'category',
                    boundaryGap: true,
                    data: data.labels,
                    axisLabel: { color: '#000', fontSize: 14, fontWeight: 'bold' },
                    axisLine: { lineStyle: { color: '#333', width: 2 } },
                    axisTick: { show: true, lineStyle: { color: '#333', width: 1 } },
                    splitLine: { show: true, lineStyle: { color: '#ddd', width: 1 } }
                },
                yAxis: {
                    type: 'value',
                    axisLabel: { color: '#000', fontSize: 14, fontWeight: 'bold' },
                    axisLine: { lineStyle: { color: '#333', width: 2 } },
                    axisTick: { show: true, lineStyle: { color: '#333', width: 1 } },
                    splitLine: { show: true, lineStyle: { color: '#ddd', width: 1 } }
                },
                series: [
                    {
                        name: name,
                        type: 'bar',
                        data: data.values.map(value => ({
                            value: value,
                            itemStyle: { color: colorFunc(value) }
                        })),
                        emphasis: {
                            itemStyle: {
                                borderColor: 'rgba(0, 0, 0, 0.7)'
                            }
                        }
                    }
                ]
            };
        }

        function fetchData() {
            $.ajax({
                url: "{% url 'get_data' esp_id=esp_id %}",
                method: 'GET',
                success: function(data) {
                    var now = new Date();
                    var time = now.getHours() + ":" + now.getMinutes() + ":" + now.getSeconds();
                    
                    temperatureData.labels.push(time);
                    temperatureData.values.push(data.temperature);

                    humidityData.labels.push(time);
                    humidityData.values.push(data.humidity);

                    gazData.labels.push(time);
                    gazData.values.push(data.gaz);

                    if (temperatureData.labels.length > 10) {
                        temperatureData.labels.shift();
                        temperatureData.values.shift();
                        humidityData.labels.shift();
                        humidityData.values.shift();
                        gazData.labels.shift();
                        gazData.values.shift();
                    }

                    // Mettre à jour les graphiques avec les couleurs dynamiques
                    temperatureChart.setOption(createStackedBarOption('Température', temperatureData, getTemperatureColor));
                    humidityChart.setOption(createStackedBarOption('Humidité', humidityData, getHumidityColor));
                    gazChart.setOption(createStackedBarOption('Gaz', gazData, getGazColor));

                    $('#temperature').text(data.temperature + '°C');
                    $('#humidity').text(data.humidity + '%');
                    $('#gaz').text(data.gaz + 'PPT');
                },
                error: function() {
                    console.log('Erreur lors de la récupération des données');
                }
            });
        }

        fetchData();
        setInterval(fetchData, 2000);
    });
</script>

{% endblock content %}
