{% extends 'admini\base.html' %}

{% load static %}
{% load i18n %}
{% block content %}

<link rel="stylesheet" href="{% static 'adm/css/tous_graphe.css' %}">
<link rel="stylesheet" href="{% static 'adm/css/menu_graphe.css' %}">
<div id="container">
    <div class="d-flex justify-content-between align-items-center">
        <h4 class="text-center alert text-bg-warning mb-xxl-5" style="width: 80%; margin-left: 50px;">Affichage des données actuelle: {{esp.lieu}}</h4>
       
        <ul class="menu text-center alert text-bg-warning mb-xxl-5">
            <li class="dropdown">
                <a href="#">Type de graphique <i class="fas fa-caret-down"></i></a>
                <ul class="dropdown-menu">
                    <li><a href="{% url 'courbe_admin' esp_id=esp_id %}">Graphique courbe</a></li>
                    <li><a href="{% url 'bar_admin' esp_id=esp_id %}">Graphique bar</a></li>
                    <li><a href="{% url 'jauge_admin' esp_id=esp_id %}">Graphique jauge</a></li>
                    <li><a href="{% url 'histo_esp' esp_id=esp_id %}">Historique</a></li>
                </ul>
            </li>
        </ul>
    </div>
    <div class="charts-container">
        <div class="charts-row">
            <div class="chart-wrapper">
                <p style="text-align: center;"><strong>Température : <span id="temperature">--</span></strong></p>
                <div id="temperatureChart" class="chart" style="width: 700px; height: 400px;"></div>
            </div>

            <div class="chart-wrapper">
                <p style="text-align: center;"><strong>Humidité : <span id="humidity">--</span></strong></p>
                <div id="humidityChart" class="chart" style="width: 700px; height: 400px;"></div>
            </div>
        </div>

        <div class="chart-wrapper">
            <div class="chart-gaz">
                <p style="text-align: center;"><strong>Gaz : <span id="gaz">--</span></strong></p>
                <div id="gazChart" class="chart" style="width: 700px; height: 400px; margin: 0;"></div>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function() {
        // Initialisation des graphiques
        var temperatureChart = echarts.init(document.getElementById('temperatureChart'));
        var humidityChart = echarts.init(document.getElementById('humidityChart'));
        var gazChart = echarts.init(document.getElementById('gazChart'));

        // Fonction pour créer les options de la jauge
        function createGaugeOption(label, value, min, max, unit, colorRanges) {
            return {
                tooltip: {
                    formatter: '{a} <br/>{b} : {c}' + unit
                },
                series: [
                    {
                        name: label,
                        type: 'gauge',
                        radius: '90%',
                        min: min,
                        max: max,
                        splitNumber: 10,
                        axisLine: {
                            lineStyle: {
                                color: colorRanges,
                                width: 10
                            }
                        },
                        axisTick: {
                            length: 15,
                            lineStyle: {
                                color: 'auto'
                            }
                        },
                        splitLine: {
                            length: 20,
                            lineStyle: {
                                color: 'auto'
                            }
                        },
                        title: {
                            show: true,
                            offsetCenter: [0, '-30%'],
                            textStyle: {
                                fontSize: 20
                            }
                        },
                        detail: {
                            formatter: '{value}' + unit,
                            fontSize: 20
                        },
                        data: [{ value: value, name: label }]
                    }
                ]
            };
        }

        // Fonction pour récupérer les données
        function fetchData() {
            $.ajax({
                url: "{% url 'get_data' esp_id=esp_id %}",
                method: 'GET',
                success: function(data) {
                    $('#temperature').text(data.temperature + '°C');
                    $('#humidity').text(data.humidity + '%');
                    $('#gaz').text(data.gaz + 'PPT');

                    // Mise à jour des jauges
                    temperatureChart.setOption(createGaugeOption('Température', data.temperature, 0, 50, '°C', [
                        [0.4, '#0000FF'], // Bleu pour 0 à 20
                        [0.5, '#008000'], // Vert pour 20 à 25
                        [1, '#FF0000']    // Rouge au-dessus de 25
                    ]));

                    humidityChart.setOption(createGaugeOption('Humidité', data.humidity, 0, 100, '%', [
                        [0.4, '#0000FF'], // Vert pour 0 à 40
                        [0.6, '#008000'], // Bleu pour 40 à 60
                        [1, '#FF0000']    // Rouge au-dessus de 60
                    ]));

                    gazChart.setOption(createGaugeOption('Gaz', data.gaz, 0, 2000, 'mg/L', [
                        [0.5, '#008000'], // Vert pour inférieur à 1000
                        [1, '#FF0000']    // Rouge au-dessus de 1000
                    ]));
                },
                error: function() {
                    console.log('Erreur lors de la récupération des données');
                }
            });
        }

        // Appel initial pour obtenir les données immédiatement
        fetchData();

        // Appel périodique pour mettre à jour les données
        setInterval(fetchData, 2000); // Met à jour toutes les 2 secondes
    });
</script>

{% endblock content %}
