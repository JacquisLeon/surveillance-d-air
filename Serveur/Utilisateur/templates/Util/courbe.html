{% extends 'Util/base.html' %}

{% load static %}
{% block content %}
<link rel="stylesheet" href="{% static 'adm/css/menu_graphe.css' %}">
<link rel="stylesheet" href="{% static 'adm/css/tous_graphe.css' %}">
<div id="container">
    <div class="d-flex justify-content-between align-items-center" >
        <h5 class="text-center alert text-bg-warning mb-xxl-5" style="width: 80%; margin-left: 50px;"><strong>Affichage des données actuelle de {{esp.lieu}}</strong></h5>
    
       
            <ul class="menu text-center alert text-bg-warning mb-xxl-5">
                <li class="dropdown">
                    <a href="#">Type de graphique <i class="fas fa-caret-down"></i></a>
                    <ul class="dropdown-menu">
                        <li><a href="{% url 'courbe_data' esp_id=esp_id %}">Graphique courbe</a></li>
                        <li><a href="{% url 'bar_data' esp_id=esp_id %}">Graphique bar</a></li>
                        <li><a href="{% url 'jauge_data' esp_id=esp_id %}">Graphique jauge</a></li>
                        <li><a href="{% url 'historique' esp_id=esp_id %}">Historique</a></li>
                    </ul>
                </li>
            </ul>
        
    </div>
    <div class="charts-container">
        <!-- Sous-conteneur pour la température et l'humidité côte à côte -->
        <div class="charts-row">
            <!-- Sous-conteneur pour la température -->
            <div class="chart-wrapper">
                <p style="text-align: center;"><strong>Température : <span id="temperature">--</span></strong></p>
                <div id="temperatureChart" class="chart" style="width: 700px; height: 400px;"></div>
            </div>

            <!-- Sous-conteneur pour l'humidité -->
            <div class="chart-wrapper">
                <p style="text-align: center;"><strong>Humidité : <span id="humidity">--</span></strong></p>
                <div id="humidityChart" class="chart" style="width: 700px; height: 400px;"></div>
            </div>
        </div>

        <!-- Sous-conteneur pour le gaz en dessous de la température -->
        <div class="chart-wrapper">
        <div class="chart-gaz">
            <p style="text-align: center;"><strong>Gaz : <span id="gaz">--</span></strong></p>
            <div id="gazChart" class="chart" style="width: 700px; height: 400px; margin: 0;"></div>
        </div>
    </div>
    </div>

    
</div>


<script>
   $(document).ready(function() {
       var temperatureChart = echarts.init(document.getElementById('temperatureChart'));
       var humidityChart = echarts.init(document.getElementById('humidityChart'));
       var gazChart = echarts.init(document.getElementById('gazChart'));

       var temperatureData = { labels: [], values: [] };
       var humidityData = { labels: [], values: [] };
       var gazData = { labels: [], values: [] };

       function createLineOption(name, color, data) {
    return {
        xAxis: {
            type: 'category',
            boundaryGap: false,
            data: data.labels,
            axisLabel: {
                color: '#000',
                fontSize: 14,
                fontWeight: 'bold'
            },
            axisLine: {
                lineStyle: {
                    color: '#333',
                    width: 2
                }
            },
            axisTick: {
                show: true,
                lineStyle: {
                    color: '#333',
                    width: 1
                }
            },
            splitLine: {
                show: true,
                lineStyle: {
                    color: '#ddd', // Couleur des lignes de grille
                    width: 1 // Épaisseur des lignes de grille
                }
            }
        },
        yAxis: {
            type: 'value',
            axisLabel: {
                color: '#000',
                fontSize: 14,
                fontWeight: 'bold'
            },
            axisLine: {
                lineStyle: {
                    color: '#333',
                    width: 2
                }
            },
            axisTick: {
                show: true,
                lineStyle: {
                    color: '#333',
                    width: 1
                }
            },
            splitLine: {
                show: true,
                lineStyle: {
                    color: '#ddd', // Couleur des lignes de grille
                    width: 1 // Épaisseur des lignes de grille
                }
            }
        },
        series: [
            {
                name: name,
                type: 'line',
                smooth: true,
                data: data.values,
                lineStyle: {
                    color: color
                },
                itemStyle: {
                    color: color,
                    borderColor: 'rgba(0, 0, 0, 0.5)',
                    borderWidth: 2
                },
                symbol: 'circle',
                symbolSize: 8,
                emphasis: {
                    itemStyle: {
                        color: color,
                        borderColor: 'rgba(0, 0, 0, 0.7)'
                    }
                }
            }
        ]
    };
}


function fetchData() {
    $.ajax({
        url: "{% url 'get_data' esp_id=esp_id %}",  // Passe l'ID de l'ESP ici
        method: 'GET',
        success: function(data) {
            var now = new Date();
            var time = now.getHours() + ":" + now.getMinutes() + ":" + now.getSeconds();
            
            // Ajouter les nouvelles valeurs
            temperatureData.labels.push(time);
            temperatureData.values.push(data.temperature);
            humidityData.labels.push(time);
            humidityData.values.push(data.humidity);
            gazData.labels.push(time);
            gazData.values.push(data.gaz);

            // Limiter à 5 points pour chaque jeu de données
            if (temperatureData.labels.length > 10) {
                temperatureData.labels.shift();  // Supprime le premier élément (le plus ancien)
                temperatureData.values.shift();
            }
            if (humidityData.labels.length > 10) {
                humidityData.labels.shift();
                humidityData.values.shift();
            }
            if (gazData.labels.length > 10) {
                gazData.labels.shift();
                gazData.values.shift();
            }

            // Mettre à jour les graphiques
            temperatureChart.setOption(createLineOption('Température', '#ff0000', temperatureData));
            humidityChart.setOption(createLineOption('Humidité', '#0000ff', humidityData));
            gazChart.setOption(createLineOption('Gaz', '#00ff00', gazData));

            // Mettre à jour les valeurs affichées
            $('#temperature').text(data.temperature);
            $('#humidity').text(data.humidity);
            $('#gaz').text(data.gaz);
        },
        error: function() {
            console.log('Erreur lors de la récupération des données');
        }
    });
}




       // Appel initial pour obtenir les données immédiatement
       fetchData();

       // Appel périodique pour mettre à jour les données
       setInterval(fetchData, 2000); // Met à jour toutes les 2 secondes
   });
</script>
  
{% endblock content %}
